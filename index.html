<!DOCTYPE html>
<html lang="ja" class="theme-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ホーム | StudySpark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=SF+Pro+Display:wght@400;500;600;700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style type="text/tailwindcss">
        :root {
            --ios-blue: #0A84FF;
            --ios-orange: #FF9F0A;
            --ios-green: #30D158;
            --ios-red: #FF453A;
            --ios-purple: #BF5AF2;
            --background-dark: #000000;
            --card-background-dark: rgba(28, 28, 30, 0.7);
            --text-primary-dark: #FFFFFF;
            --text-secondary-dark: #8E8E93;
            --glass-blur: 16px;
            --glass-border-color-dark: rgba(255, 255, 255, 0.15);
            
            --background-light: #f8fcfa;
            --card-background-light: #ffffff;
            --text-primary-light: #0c1c17;
            --text-secondary-light: #555;
            --glass-border-color-light: #e6f4ef;
        }
        body {
            font-family: 'SF Pro Display', 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            opacity: 0;
        }
        body.loaded {
            opacity: 1;
        }
        .theme-dark {
            background-color: var(--background-dark);
            color: var(--text-primary-dark);
        }
        .theme-light {
            background-color: var(--background-light);
            color: var(--text-primary-light);
        }
        .aurora-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0;
            background:
                radial-gradient(ellipse at 20% 80%, var(--ios-blue) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, var(--ios-orange) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, var(--ios-green) 0%, transparent 60%);
            animation: aurora-swirl 30s infinite linear alternate;
            filter: blur(40px);
            transition: opacity 0.5s;
        }
        .theme-dark .aurora-background { opacity: 0.3; }

        .glass-card {
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            border-radius: 20px;
        }
        .theme-dark .glass-card {
            background-color: var(--card-background-dark);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color-dark);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.35);
        }
        .theme-light .glass-card {
            background-color: var(--card-background-light);
            border: 1px solid var(--glass-border-color-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .ios-icon-button {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .theme-dark .ios-icon-button { background-color: rgba(120, 120, 128, 0.18); color: var(--text-primary-dark); }
        .theme-light .ios-icon-button { background-color: #e5e7eb; color: #374151; }
        .ios-icon-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #ai-advice-container ul { list-style-type: disc; padding-left: 1.5rem; }
        .hidden { display: none; }
        
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; visibility: hidden; }
        .popup-overlay.visible { opacity: 1; visibility: visible; }
        .popup-content { padding: 2rem; border-radius: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; position: relative; }
        .popup-overlay.visible .popup-content { transform: scale(1); }
        .popup-close-button { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        .popup-form-input { margin-top: 0.25rem; display: block; width: 100%; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .theme-dark .popup-form-input { background-color: rgba(120, 120, 128, 0.18); border: 1px solid var(--glass-border-color-dark); color: var(--text-primary-dark); }
        .theme-light .popup-form-input { background-color: #fff; border: 1px solid #d1d5db; color: var(--text-primary-light); }
        
        .sortable-ghost { opacity: 0.4; background: var(--ios-blue); }

        .weekly-schedule-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
        .day-column { border-radius: 1rem; padding: 1rem; min-height: 200px; display: flex; flex-direction: column; }
        .theme-dark .day-column { background-color: rgba(255,255,255,0.05); }
        .theme-light .day-column { background-color: #f9fafb; }
        .day-header { font-weight: 600; margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
        .day-header .date-text { font-size: 0.875rem; }
        .theme-dark .day-header .date-text { color: var(--text-secondary-dark); }
        .theme-light .day-header .date-text { color: var(--text-secondary-light); }
        .day-header .day-name { font-size: 1.125rem; }
        .day-header .add-task-btn { background: none; border: none; color: var(--text-secondary-dark); cursor: pointer; padding: 0.25rem; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .task-list { list-style: none; padding: 0; margin: 0; space-y: 0.5rem; flex-grow: 1; }
        .task-item { padding: 0.6rem 0.75rem; border-radius: 0.5rem; font-size: 0.85rem; line-height: 1.4; display: flex; align-items: flex-start; gap: 0.6rem; }
        .task-item i { margin-top: 3px; }
        .task-review { background-color: rgba(255, 159, 10, 0.2); }
        .task-ai { background-color: rgba(10, 132, 255, 0.2); }
        .task-user { background-color: rgba(48, 209, 88, 0.2); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--ios-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        .survey-tab-button { padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .theme-dark .survey-tab-button { background-color: rgba(255,255,255,0.1); }
        .theme-light .survey-tab-button { background-color: #e5e7eb; }
        .survey-tab-button.active { color: white; background-color: var(--ios-blue); }

        .survey-checkbox-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .theme-dark .survey-checkbox-item:hover { background-color: rgba(255,255,255,0.05); }
        .theme-light .survey-checkbox-item:hover { background-color: #f9fafb; }
        .survey-checkbox-item input[type="checkbox"] { display: none; }
        .survey-checkbox-item .custom-checkbox { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-secondary-dark); transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .survey-checkbox-item input[type="checkbox"]:checked + .custom-checkbox { background-color: var(--ios-blue); border-color: var(--ios-blue); }
        .survey-checkbox-item input[type="checkbox"]:checked + .custom-checkbox::after { content: '✔'; color: white; font-size: 12px; }
        
        .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: color 0.2s, background-color 0.2s;
        }
        .theme-dark .nav-link { color: var(--text-secondary-dark); }
        .theme-light .nav-link { color: var(--text-secondary-light); }
        .theme-dark .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--text-primary-dark); }
        .theme-light .nav-link:hover { background-color: #e5e7eb; }

        .nav-link.active {
            font-weight: 600;
        }
        .theme-dark .nav-link.active { background-color: var(--ios-blue); color: white; }
        .theme-light .nav-link.active { background-color: var(--ios-blue); color: white; }

    </style>
    <script>
        const savedTheme = localStorage.getItem('学習記録アプリ_テーマ') || 'dark';
        document.documentElement.className = `theme-${savedTheme}`;
    </script>
</head>
<body class="opacity-0 transition-opacity duration-500">
<div class="aurora-background"></div>

<!-- Popups -->
<div id="aiSettingsPopup" class="popup-overlay glass-card">
    <div class="popup-content">
        <button data-action="close-popup" class="popup-close-button" aria-label="閉じる">&times;</button>
        <h2 class="text-xl font-bold mb-6">AI計画の設定</h2>
        
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-semibold mb-3">現在の計画の根拠</h3>
                <div id="ai-plan-basis-container" class="text-sm p-4 rounded-lg bg-black/20 theme-light:bg-gray-100 space-y-2">
                    <p>（ここに計画の根拠が表示されます）</p>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-semibold mb-3">今週の学習アンケート</h3>
                <form id="ai-survey-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">今週、特に集中したいことは？ (複数選択可)</label>
                        <div class="flex items-center gap-2 p-1 rounded-full bg-black/10 theme-light:bg-gray-200 mb-3">
                            <button type="button" data-action="switch-survey-tab" data-tab="subjects" class="survey-tab-button active w-1/2">教科</button>
                            <button type="button" data-action="switch-survey-tab" data-tab="textbooks" class="survey-tab-button w-1/2">教材</button>
                        </div>
                        <div id="survey-subjects-container" class="space-y-2 max-h-40 overflow-y-auto"></div>
                        <div id="survey-textbooks-container" class="hidden space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label for="survey-pace" class="block text-sm font-medium mb-1">今週の学習ペース</label>
                        <select id="survey-pace" class="popup-form-input">
                            <option value="normal">通常通り</option>
                            <option value="relaxed">少しゆっくり</option>
                            <option value="intensive">集中的に</option>
                        </select>
                    </div>
                    <div>
                        <label for="survey-feeling" class="block text-sm font-medium mb-1">今週の意気込みは？</label>
                        <input type="text" id="survey-feeling" class="popup-form-input" placeholder="例: 絶対に目標達成する！、少し不安">
                    </div>
                    <button type="submit" class="w-full bg-[var(--ios-blue)] text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold">計画を更新</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="addTaskPopup" class="popup-overlay glass-card">
    <div class="popup-content">
        <button data-action="close-popup" class="popup-close-button" aria-label="閉じる">&times;</button>
        <h2 class="text-xl font-bold mb-2">予定の追加</h2>
        <p id="addTaskDate" class="text-sm text-gray-400 mb-6"></p>
        <form id="addTaskForm" class="space-y-4">
            <input type="hidden" id="taskDateInput">
            <input type="hidden" id="taskSubjectInput">
            <div>
                <label for="taskTextInput" class="block text-sm font-medium">予定の内容</label>
                <textarea id="taskTextInput" class="popup-form-input" rows="3" required></textarea>
            </div>
            <div>
                <span class="block text-sm font-medium">教科タグ</span>
                <div id="taskSubjectTags" class="subject-tag-list"></div>
            </div>
            <button type="submit" class="w-full bg-[var(--ios-blue)] text-white py-2 px-4 rounded-lg hover:bg-blue-700 font-semibold">保存する</button>
        </form>
    </div>
</div>

<div id="main-content" class="relative flex size-full min-h-screen flex-col bg-transparent group/design-root overflow-x-hidden">
<header class="sticky top-0 z-50 px-4 sm:px-6 py-3 shadow-sm border-b glass-card !rounded-none">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="size-9 text-[var(--ios-blue)]">
                <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="logoGradientHeader" x1="0%" x2="100%" y1="0%" y2="100%"><stop offset="0%" style="stop-color:var(--ios-blue);stop-opacity:1"></stop><stop offset="100%" style="stop-color:var(--ios-orange);stop-opacity:1"></stop></linearGradient></defs><path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z" fill="url(#logoGradientHeader)"></path></svg>
            </div>
            <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">StudySpark</h2>
        </div>
        
        <nav class="hidden md:flex items-center gap-1 p-1 rounded-xl bg-black/10 theme-light:bg-gray-200">
            <a href="index.html" class="nav-link active">ホーム</a>
            <a href="record.html" class="nav-link">記録</a>
            <a href="data.html" class="nav-link">データ</a>
            <a href="others.html" class="nav-link">その他</a>
        </nav>

        <div class="flex items-center gap-3 sm:gap-4">
             <button data-action="show-notifications" class="ios-icon-button relative" aria-label="通知">
                <i class="fas fa-envelope"></i>
                <span id="notification-badge" class="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-[var(--ios-red)] ring-2 ring-offset-1 ring-offset-gray-800 theme-light:ring-offset-gray-100 ring-transparent hidden"></span>
             </button>
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-9 border-2 border-[var(--ios-blue)] shadow-lg" style='background-image: url("https://placehold.co/100x100/000000/FFFFFF?text=U");'></div>
        </div>
    </div>
</header>

<!-- Notification Panel -->
<div id="notificationsPanel" class="hidden absolute top-[70px] right-4 sm:right-6 md:right-10 lg:right-16 z-50 w-80 max-w-sm glass-card p-4 shadow-lg transition-opacity duration-300">
    <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-lg">通知</h3>
        <button data-action="close-notifications" class="text-gray-400 hover:text-white">&times;</button>
    </div>
    <ul id="notification-list" class="space-y-2 max-h-80 overflow-y-auto">
        <!-- Notifications will be injected here -->
    </ul>
    <p id="no-notification-message" class="text-center text-gray-400 py-4 hidden">通知はありません。</p>
</div>

<main class="px-4 sm:px-6 md:px-10 lg:px-16 flex flex-1 justify-center py-8 sm:py-10">
    <div class="layout-content-container flex flex-col w-full max-w-7xl gap-8 sm:gap-10">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-6 sm:p-8 glass-card">
            <div>
                <h1 class="tracking-tight text-2xl sm:text-3xl font-semibold leading-tight">おかえりなさい、<span class="animated-gradient-text">学習者さん！</span></h1>
                <p class="text-sm text-[var(--text-secondary-dark)] theme-light:text-[var(--text-secondary-light)] mt-1">今日の学習を始めましょう！</p>
            </div>
            <div>
                <button data-action="edit-layout" class="ios-icon-button" title="レイアウトを編集" aria-label="レイアウトを編集">
                    <i class="fas fa-edit"></i>
                </button>
                <div id="edit-layout-controls" class="hidden items-center gap-3">
                    <button data-action="cancel-layout" class="px-4 py-2 rounded-lg bg-black/20 theme-light:bg-gray-200 hover:bg-black/30 theme-light:hover:bg-gray-300 font-semibold transition-colors">キャンセル</button>
                    <button data-action="save-layout" class="px-4 py-2 rounded-lg bg-[var(--ios-blue)] text-white hover:bg-blue-600 font-semibold transition-colors">保存</button>
                </div>
            </div>
        </div>
        
        <div id="sortable-sections" class="flex flex-col gap-8 sm:gap-10">
            <section data-section-id="overview">
                <div class="flex justify-between items-center px-1 pb-4 sm:pb-5">
                    <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">学習状況の概要</h2>
                    <div class="drag-handle hidden cursor-move text-gray-500"><i class="fas fa-grip-vertical"></i></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 sm:gap-6">
                    <div class="flex flex-col gap-3 p-6 sm:p-7 glass-card hover-lift">
                        <p class="text-sm font-medium leading-normal text-[var(--text-secondary-dark)] theme-light:text-[var(--text-secondary-light)]">今日の学習時間</p>
                        <p id="today-total-time" class="tracking-tight text-3xl sm:text-4xl font-bold leading-tight">0分</p>
                        <div id="today-progress-bar" class="w-full h-2.5 bg-black/20 theme-light:bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner"></div>
                        <div id="today-legend" class="text-xs mt-2 flex flex-wrap gap-x-3 gap-y-1"></div>
                    </div>
                    <div class="flex flex-col gap-3 p-6 sm:p-7 glass-card hover-lift">
                        <p class="text-sm font-medium leading-normal text-[var(--text-secondary-dark)] theme-light:text-[var(--text-secondary-light)]">連続学習</p>
                        <p id="streak-days" class="tracking-tight text-3xl sm:text-4xl font-bold leading-tight">0 日</p>
                        <div class="flex mt-2 space-x-1.5" id="streak-icons"></div>
                    </div>
                    <div class="flex flex-col gap-3 p-6 sm:p-7 glass-card hover-lift">
                        <p class="text-sm font-medium leading-normal text-[var(--text-secondary-dark)] theme-light:text-[var(--text-secondary-light)]">今週の学習時間</p>
                        <p id="week-total-time" class="tracking-tight text-3xl sm:text-4xl font-bold leading-tight">0時間 0分</p>
                        <div id="week-progress-bar" class="w-full h-2.5 bg-black/20 theme-light:bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner"></div>
                        <div id="week-legend" class="text-xs mt-2 flex flex-wrap gap-x-3 gap-y-1"></div>
                    </div>
                </div>
            </section>

            <section data-section-id="weekly-schedule">
                <div class="flex flex-wrap justify-between items-center gap-4 px-1 pb-4 sm:pb-5">
                    <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">週間予定表</h2>
                    <div class="flex items-center gap-2 sm:gap-4">
                         <div class="flex items-center gap-2">
                            <label for="ai-schedule-toggle" class="text-sm font-medium text-gray-400 cursor-pointer">AI提案</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="ai-schedule-toggle">
                                <span class="slider"></span>
                            </label>
                         </div>
                         <div class="flex items-center gap-2">
                             <button data-action="prev-week" class="ios-icon-button !w-8 !h-8" aria-label="前の週へ"><i class="fas fa-chevron-left"></i></button>
                             <span id="week-range-display" class="text-sm font-medium text-gray-400 w-32 text-center"></span>
                             <button data-action="next-week" class="ios-icon-button !w-8 !h-8" aria-label="次の週へ"><i class="fas fa-chevron-right"></i></button>
                         </div>
                         <div class="drag-handle hidden cursor-move text-gray-500 ml-4"><i class="fas fa-grip-vertical"></i></div>
                    </div>
                </div>
                <div id="weekly-schedule-container" class="glass-card p-4 sm:p-6">
                    <div id="weekly-schedule-grid" class="weekly-schedule-grid"></div>
                </div>
            </section>

            <section data-section-id="review">
                <div class="flex justify-between items-center px-1 pb-4 sm:pb-5">
                    <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">今日の復習</h2>
                    <div class="drag-handle hidden cursor-move text-gray-500"><i class="fas fa-grip-vertical"></i></div>
                </div>
                <div id="review-list" class="space-y-6"></div>
                <p id="no-review-message" class="hidden glass-card text-center text-gray-400 p-6 rounded-xl">今日の復習項目はありません。</p>
            </section>

            <section data-section-id="ai-analysis">
                 <div class="flex justify-between items-center px-1 pb-4 sm:pb-5">
                    <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">AIによる分析</h2>
                    <div class="drag-handle hidden cursor-move text-gray-500"><i class="fas fa-grip-vertical"></i></div>
                </div>
                <div class="p-6 sm:p-8 glass-card hover-lift">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">週次計画とアドバイス</h3>
                        <div class="flex items-center gap-2">
                            <button data-action="refresh-ai-plan" class="ios-icon-button !w-8 !h-8" title="計画を再生成" aria-label="計画を再生成">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button data-action="open-ai-settings" class="ios-icon-button !w-8 !h-8" title="AI計画の設定" aria-label="AI計画の設定">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div id="ai-container" >
                        <p id="ai-loading-message" class="text-gray-400 hidden">AIが計画を作成中です...</p>
                        <div id="ai-advice-container" class="mt-6 border-t pt-6 border-[var(--glass-border-color-dark)] theme-light:border-[var(--glass-border-color-light)]"></div>
                    </div>
                </div>
            </section>
            
            <section data-section-id="recent-records">
                <div class="flex justify-between items-center px-1 pb-4 sm:pb-5">
                    <h2 class="text-xl sm:text-2xl font-semibold leading-tight tracking-tight">最近の学習記録から予定を作成</h2>
                    <div class="drag-handle hidden cursor-move text-gray-500"><i class="fas fa-grip-vertical"></i></div>
                </div>
                <div id="recent-records-list" class="space-y-4"></div>
            </section>
        </div>
    </div>
</main>
</div>
<script>
(() => {
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            isAiRunning: false,
            weekOffset: 0,
            sortableInstance: null,
            aiSchedule: null,
        };

        const DOMElements = {
            body: document.body,
            mainContent: document.getElementById('main-content'),
            weeklyScheduleGrid: document.getElementById('weekly-schedule-grid'),
            weekRangeDisplay: document.getElementById('week-range-display'),
            aiScheduleToggle: document.getElementById('ai-schedule-toggle'),
            addTaskPopup: document.getElementById('addTaskPopup'),
            addTaskForm: document.getElementById('addTaskForm'),
            aiSettingsPopup: document.getElementById('aiSettingsPopup'),
            aiSurveyForm: document.getElementById('ai-survey-form'),
            recentRecordsList: document.getElementById('recent-records-list'),
            reviewListEl: document.getElementById('review-list'),
            noReviewMessageEl: document.getElementById('no-review-message'),
            aiAdviceContainer: document.getElementById('ai-advice-container'),
            aiLoadingMessage: document.getElementById('ai-loading-message'),
            refreshAiPlanBtn: document.querySelector('[data-action="refresh-ai-plan"]'),
            todayTotalTimeEl: document.getElementById('today-total-time'),
            todayProgressBarEl: document.getElementById('today-progress-bar'),
            todayLegendEl: document.getElementById('today-legend'),
            streakDaysEl: document.getElementById('streak-days'),
            streakIconsEl: document.getElementById('streak-icons'),
            weekTotalTimeEl: document.getElementById('week-total-time'),
            weekProgressBarEl: document.getElementById('week-progress-bar'),
            weekLegendEl: document.getElementById('week-legend'),
            sortableSectionsContainer: document.getElementById('sortable-sections'),
            notificationsPanel: document.getElementById('notificationsPanel'),
            notificationList: document.getElementById('notification-list'),
            notificationBadge: document.getElementById('notification-badge'),
            noNotificationMessage: document.getElementById('no-notification-message'),
        };

        const CONSTANTS = {
            LAYOUT_ORDER_KEY: '学習記録アプリ_レイアウト順序',
            RECORDS_KEY: '学習記録アプリ_日々の記録',
            REVIEW_ITEMS_KEY: '学習記録アプリ_復習項目',
            USER_TASKS_KEY: '学習記録アプリ_ユーザー予定',
            AI_PLAN_KEY_PREFIX: '学習記録アプリ_AI計画_',
            AI_SCHEDULE_VISIBLE_KEY: '学習記録アプリ_AI表示',
            API_KEY_KEY: '学習記録アプリ_GeminiAPIキー',
            COLOR_PALETTE: ['#0A84FF', '#FF9F0A', '#30D158', '#FF453A', '#BF5AF2', '#5E5CE6', '#AC8E68', '#FF375F'],
            REVIEW_INTERVALS: [1, 3, 7, 14, 30, 60],
            LIBRARY_KEY: '学習記録アプリ_ライブラリ',
            AI_PLAN_BASIS_KEY_PREFIX: '学習記録アプリ_AI計画根拠_',
            AI_SURVEY_KEY_PREFIX: '学習記録アプリ_AIアンケート_',
        };
        const subjectColorMap = new Map();
        let colorIndex = 0;

        const utils = {
            loadData: (key, defaultValue = []) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (error) {
                    console.error(`Error parsing JSON for key "${key}":`, error);
                    localStorage.removeItem(key);
                    return defaultValue;
                }
            },
            saveData: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving data for key "${key}":`, error);
                }
            },
            dateToYYYYMMDD: (d) => d.toISOString().split('T')[0],
            parseDateAsLocal: (dateString) => {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            },
            addDays: (date, days) => {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            },
            getWeekNumber: (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                return `${d.getUTCFullYear()}-W${String(Math.ceil((((d - yearStart) / 86400000) + 1) / 7)).padStart(2, '0')}`;
            },
            getColorForSubject: (subject) => {
                if (!subject) return '#8E8E93';
                if (!subjectColorMap.has(subject)) {
                    subjectColorMap.set(subject, CONSTANTS.COLOR_PALETTE[colorIndex % CONSTANTS.COLOR_PALETTE.length]);
                    colorIndex++;
                }
                return subjectColorMap.get(subject);
            },
            formatTime: (totalMinutes) => {
                if (!totalMinutes || totalMinutes === 0) return "0分";
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                return `${h > 0 ? h + '時間 ' : ''}${m > 0 ? m + '分' : ''}`.trim() || '0分';
            },
            triggerConfetti: () => {
                if (typeof confetti === 'function') {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
            },
            closeAllPopups: () => {
                document.querySelectorAll('.popup-overlay').forEach(popup => popup.classList.remove('visible'));
            },
        };

        const render = {
            dashboard: () => {
                const records = utils.loadData(CONSTANTS.RECORDS_KEY);
                const today = utils.dateToYYYYMMDD(new Date());
                const weekStart = new Date();
                weekStart.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));
                const weekStartStr = utils.dateToYYYYMMDD(weekStart);
                render.studyTimeUI('today', records.filter(r => r.date === today));
                render.studyTimeUI('week', records.filter(r => r.date >= weekStartStr));
                render.streak(records);
            },
            studyTimeUI: (period, records) => {
                const [totalTimeEl, progressBarEl, legendEl] = period === 'today' 
                    ? [DOMElements.todayTotalTimeEl, DOMElements.todayProgressBarEl, DOMElements.todayLegendEl] 
                    : [DOMElements.weekTotalTimeEl, DOMElements.weekProgressBarEl, DOMElements.weekLegendEl];
                if (!totalTimeEl || !progressBarEl || !legendEl) return;
                
                progressBarEl.innerHTML = '';
                legendEl.innerHTML = '';
                const totalMinutes = records.reduce((sum, r) => sum + r.time, 0);
                totalTimeEl.textContent = utils.formatTime(totalMinutes);

                if (totalMinutes === 0) {
                    progressBarEl.innerHTML = `<div class="h-full" style="width: 100%; background-color: rgba(120, 120, 128, 0.18);"></div>`;
                    return;
                }
                const subjectTimes = records.reduce((acc, record) => {
                    if(record.subject) {
                        acc[record.subject] = (acc[record.subject] || 0) + record.time;
                    }
                    return acc;
                }, {});
                for (const subject in subjectTimes) {
                    const percentage = (subjectTimes[subject] / totalMinutes) * 100;
                    const color = utils.getColorForSubject(subject);
                    progressBarEl.innerHTML += `<div class="h-full" style="width: ${percentage}%; background-color: ${color};" title="${subject}: ${utils.formatTime(subjectTimes[subject])}"></div>`;
                    legendEl.innerHTML += `<div class="flex items-center"><span class="w-2 h-2 rounded-full mr-1.5" style="background-color: ${color};"></span><span class="text-[var(--text-secondary-dark)] theme-light:text-[var(--text-secondary-light)]">${subject}</span></div>`;
                }
            },
            streak: (records) => {
                if (!DOMElements.streakDaysEl || !DOMElements.streakIconsEl) return;
                if (!records || records.length === 0) {
                    DOMElements.streakDaysEl.textContent = '0 日';
                    DOMElements.streakIconsEl.innerHTML = '';
                    return;
                }
                const dateSet = new Set(records.map(r => r.date));
                let streak = 0;
                let checkDate = new Date();
                if (!dateSet.has(utils.dateToYYYYMMDD(checkDate))) {
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                while (dateSet.has(utils.dateToYYYYMMDD(checkDate))) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                DOMElements.streakDaysEl.textContent = `${streak} 日`;
                DOMElements.streakIconsEl.innerHTML = Array.from({ length: Math.min(streak, 7) }, () => `<svg class="w-6 h-6 sm:w-7 sm:h-7 text-[var(--ios-orange)]" fill="currentColor" viewBox="0 0 20 20"><path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"></path></svg>`).join('');
            },
            todaysReviewItems: () => {
                if (!DOMElements.reviewListEl || !DOMElements.noReviewMessageEl) return;
                const reviewItems = utils.loadData(CONSTANTS.REVIEW_ITEMS_KEY);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const todaysReviews = reviewItems.filter(item => 
                    !item.isCompleted && utils.parseDateAsLocal(item.nextReviewDate) <= today
                );
                
                DOMElements.reviewListEl.innerHTML = '';
                DOMElements.noReviewMessageEl.classList.toggle('hidden', todaysReviews.length > 0);
                
                todaysReviews.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flex flex-col md:flex-row items-stretch justify-between gap-6 rounded-2xl glass-card p-6 shadow-lg';
                    card.innerHTML = `
                        <div class="flex flex-col gap-1 flex-1">
                            <p class="text-sm font-medium leading-normal text-[var(--ios-orange)]">${item.subject}</p>
                            <p class="text-lg font-bold leading-tight">${item.textbook}</p>
                            <p class="text-sm font-normal leading-normal mt-2 flex-grow text-gray-400">${item.scope || '特記事項なし'}</p>
                            <button data-action="complete-review" data-review-id="${item.id}" class="text-sm bg-[var(--ios-green)] text-white py-2 px-4 rounded-lg hover:bg-green-600 mt-4 self-start font-semibold">
                                <i class="fas fa-check mr-2"></i>復習完了
                            </button>
                        </div>
                        <div class="w-full md:w-1/3 h-48 md:h-auto bg-center bg-no-repeat bg-cover rounded-lg flex-shrink-0" style="background-image: url('https://placehold.co/480x270/0A0A0A/FFFFFF?text=${encodeURIComponent(item.textbook)}');"></div>
                    `;
                    DOMElements.reviewListEl.appendChild(card);
                });
            },
            weeklySchedule: () => {
                if (!DOMElements.weeklyScheduleGrid || !DOMElements.weekRangeDisplay) return;
                DOMElements.weeklyScheduleGrid.innerHTML = '';
                const allReviewItems = utils.loadData(CONSTANTS.REVIEW_ITEMS_KEY);
                const allUserTasks = utils.loadData(CONSTANTS.USER_TASKS_KEY);
                const showAiSchedule = DOMElements.aiScheduleToggle.checked;
                const jaWeekDays = ["日", "月", "火", "水", "木", "金", "土"];
                const dayOfWeekMapping = { "月曜日": 1, "火曜日": 2, "水曜日": 3, "木曜日": 4, "金曜日": 5, "土曜日": 6, "日曜日": 0 };
                
                const today = new Date();
                today.setDate(today.getDate() + state.weekOffset * 7);
                const currentDayOfWeek = today.getDay();
                
                const monday = new Date(today);
                monday.setDate(monday.getDate() - (currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1));
                const weekEnd = utils.addDays(monday, 6);
                DOMElements.weekRangeDisplay.textContent = `${monday.getMonth()+1}/${monday.getDate()} - ${weekEnd.getMonth()+1}/${weekEnd.getDate()}`;
                
                for (let i = 0; i < 7; i++) {
                    const day = utils.addDays(monday, i);
                    const dayStr = utils.dateToYYYYMMDD(day);
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'day-column';
                    if (utils.dateToYYYYMMDD(new Date()) === dayStr) {
                        dayColumn.classList.add('border-2', 'border-[var(--ios-blue)]');
                    }
                    dayColumn.innerHTML = `
                        <div class="day-header">
                            <span class="day-name">${jaWeekDays[day.getDay()]}</span>
                            <span class="date-text">${day.getMonth()+1}/${day.getDate()}</span>
                            <button data-action="add-task-open" data-date="${dayStr}" class="add-task-btn" title="予定を追加"><i class="fas fa-plus"></i></button>
                        </div>
                        <ul class="task-list space-y-2"></ul>`;
                    
                    const taskList = dayColumn.querySelector('.task-list');
                    allReviewItems.filter(item => item.nextReviewDate === dayStr && !item.isCompleted).forEach(task => {
                        taskList.innerHTML += `<li class="task-item task-review" style="border-left: 3px solid ${utils.getColorForSubject(task.subject)}"><i class="fas fa-history"></i> <div><strong>${task.subject}</strong>: ${task.textbook}</div></li>`;
                    });
                    allUserTasks.filter(task => task.date === dayStr).forEach(task => {
                        taskList.innerHTML += `<li class="task-item task-user" style="border-left: 3px solid ${task.subject ? utils.getColorForSubject(task.subject) : 'var(--ios-green)'}"><i class="fas fa-user"></i> <div>${task.subject ? `<strong>${task.subject}</strong>: ` : ''}${task.text}</div></li>`;
                    });

                    if (showAiSchedule && state.aiSchedule) {
                        const aiDayData = state.aiSchedule.find(d => dayOfWeekMapping[d.dayOfWeek] === day.getDay());
                        if (aiDayData && aiDayData.timeline) {
                            aiDayData.timeline.forEach(task => {
                                const li = document.createElement('li');
                                li.className = 'task-item task-ai';
                                li.innerHTML = `<i class="fas fa-robot text-[var(--ios-blue)]"></i> <div>${task.task}</div>`;
                                taskList.appendChild(li);
                            });
                        }
                    }
                    
                    if (taskList.children.length === 0) {
                        taskList.innerHTML = `<p class="text-xs text-center text-gray-500 mt-4">予定なし</p>`;
                    }
                    DOMElements.weeklyScheduleGrid.appendChild(dayColumn);
                }
            },
            recentRecords: () => {
                if (!DOMElements.recentRecordsList) return;
                DOMElements.recentRecordsList.innerHTML = '';
                const records = utils.loadData(CONSTANTS.RECORDS_KEY).slice(-5).reverse();
                const library = utils.loadData(CONSTANTS.LIBRARY_KEY);

                if (records.length === 0) {
                    DOMElements.recentRecordsList.innerHTML = `<p class="glass-card text-center text-gray-400 p-6 rounded-xl">まだ学習記録がありません。</p>`;
                    return;
                }
                records.forEach(record => {
                    let subject = record.subject;
                    if (!subject) {
                        const libraryItem = library.find(item => item.textbook === record.textbook);
                        if (libraryItem) {
                            subject = libraryItem.subject;
                        }
                    }
                    const displaySubject = subject || '教科未設定';

                    DOMElements.recentRecordsList.innerHTML += `
                        <div class="glass-card p-4 flex justify-between items-center">
                            <div>
                                <p class="text-xs text-gray-400">${record.date}</p>
                                <p><span class="font-bold" style="color: ${utils.getColorForSubject(displaySubject)}">${displaySubject}</span>: ${record.textbook} (${record.time}分)</p>
                            </div>
                            <button data-action="add-task-from-record" data-text="${record.textbook} ${record.scope || ''}" data-subject="${displaySubject}" class="text-sm bg-[var(--ios-purple)] text-white py-2 px-4 rounded-lg hover:opacity-80 font-semibold">
                                <i class="fas fa-plus mr-2"></i>予定に追加
                            </button>
                        </div>`;
                });
            },
            addNotification: ({ id, message, action }) => {
                const li = document.createElement('li');
                li.id = `notification-${id}`;
                li.className = 'p-3 rounded-lg hover:bg-white/10 cursor-pointer transition-colors';
                li.dataset.action = action;
                li.innerHTML = `<div class="flex items-start gap-3">
                    <div class="mt-1 w-5 h-5 flex-shrink-0 flex items-center justify-center rounded-full bg-[var(--ios-blue)] text-white text-xs"><i class="fas fa-info"></i></div>
                    <div>
                        <p class="text-sm">${message}</p>
                        <p class="text-xs text-gray-400 mt-1">たった今</p>
                    </div>
                </div>`;
                DOMElements.notificationList.appendChild(li);
                DOMElements.noNotificationMessage.classList.add('hidden');
                DOMElements.notificationBadge.classList.remove('hidden');
            },
            updateNotificationDisplay: () => {
                const hasNotifications = DOMElements.notificationList.children.length > 0;
                DOMElements.notificationBadge.classList.toggle('hidden', !hasNotifications);
                DOMElements.noNotificationMessage.classList.toggle('hidden', hasNotifications);
            },
            all: () => {
                render.dashboard();
                render.todaysReviewItems();
                render.weeklySchedule();
                render.recentRecords();
                render.updateNotificationDisplay();
            }
        };

        const actions = {
            openAiSettings: () => {
                const currentWeekNumber = utils.getWeekNumber(new Date());
                const basisKey = CONSTANTS.AI_PLAN_BASIS_KEY_PREFIX + currentWeekNumber;
                const basis = utils.loadData(basisKey, null);
                
                const loadedSurveyData = utils.loadData(CONSTANTS.AI_SURVEY_KEY_PREFIX + currentWeekNumber, {});
                const surveyData = {
                    focusSubjects: [],
                    focusTextbooks: [],
                    ...loadedSurveyData
                };

                const subjectsContainer = document.getElementById('survey-subjects-container');
                const textbooksContainer = document.getElementById('survey-textbooks-container');

                if (subjectsContainer && textbooksContainer) {
                    const records = utils.loadData(CONSTANTS.RECORDS_KEY);
                    const reviewItems = utils.loadData(CONSTANTS.REVIEW_ITEMS_KEY);
                    const allItems = [...records, ...reviewItems];
                    
                    const uniqueSubjects = [...new Set(allItems.map(item => item.subject).filter(Boolean))];
                    const uniqueTextbooks = [...new Set(allItems.map(item => item.textbook).filter(Boolean))];

                    subjectsContainer.innerHTML = '';
                    uniqueSubjects.forEach(subject => {
                        const isChecked = surveyData.focusSubjects.includes(subject);
                        subjectsContainer.innerHTML += `
                            <label class="survey-checkbox-item">
                                <input type="checkbox" name="focus-subject" value="${subject}" ${isChecked ? 'checked' : ''}>
                                <span class="custom-checkbox"></span>
                                <span class="font-medium">${subject}</span>
                            </label>`;
                    });

                    textbooksContainer.innerHTML = '';
                    uniqueTextbooks.forEach(textbook => {
                        const isChecked = surveyData.focusTextbooks.includes(textbook);
                        textbooksContainer.innerHTML += `
                            <label class="survey-checkbox-item">
                                <input type="checkbox" name="focus-textbook" value="${textbook}" ${isChecked ? 'checked' : ''}>
                                <span class="custom-checkbox"></span>
                                <span class="font-medium">${textbook}</span>
                            </label>`;
                    });
                }
                
                document.getElementById('survey-pace').value = surveyData.pace || 'normal';
                document.getElementById('survey-feeling').value = surveyData.feeling || '';

                const basisContainer = document.getElementById('ai-plan-basis-container');
                if (basisContainer) {
                    let basisHtml = '';
                    if (basis) {
                        basisHtml += `<p><strong>学習記録:</strong> ${basis.records}</p>`;
                        basisHtml += `<p><strong>復習項目:</strong> ${basis.reviewItems}</p>`;
                    }
                    if (surveyData.focusSubjects.length > 0 || surveyData.focusTextbooks.length > 0) {
                        basisHtml += `<hr class="my-2 border-gray-600">`;
                        basisHtml += `<div><p class="font-semibold">今週のアンケート回答:</p>`;
                        if(surveyData.focusSubjects.length > 0) basisHtml += `<p class="pl-2"><strong>重点教科:</strong> ${surveyData.focusSubjects.join(', ')}</p>`;
                        if(surveyData.focusTextbooks.length > 0) basisHtml += `<p class="pl-2"><strong>重点教材:</strong> ${surveyData.focusTextbooks.join(', ')}</p>`;
                        basisHtml += `<p class="pl-2"><strong>学習ペース:</strong> ${surveyData.pace || '未設定'}</p>`;
                        basisHtml += `<p class="pl-2"><strong>意気込み:</strong> ${surveyData.feeling || '未設定'}</p></div>`;
                    }
                    if (!basisHtml) {
                        basisHtml = `<p>計画の根拠データがまだありません。</p>`;
                    }
                    basisContainer.innerHTML = basisHtml;
                }
                DOMElements.aiSettingsPopup?.classList.add('visible');
            },
            checkForSurveyNotification: () => {
                const weekNumber = utils.getWeekNumber(new Date());
                const surveyData = utils.loadData(CONSTANTS.AI_SURVEY_KEY_PREFIX + weekNumber, null);
                if (!surveyData) {
                    render.addNotification({
                        id: 'weekly-survey',
                        message: 'より良い計画のために、今週の学習アンケートにご協力ください。',
                        action: 'open-survey-from-notification'
                    });
                }
            },
            clearSurveyNotification: () => {
                const notificationEl = document.getElementById('notification-weekly-survey');
                if (notificationEl) {
                    notificationEl.remove();
                    render.updateNotificationDisplay();
                }
            },
            applyCustomLayout: () => {
                const savedOrder = utils.loadData(CONSTANTS.LAYOUT_ORDER_KEY);
                if (DOMElements.sortableSectionsContainer && savedOrder.length > 0) {
                    savedOrder.forEach(sectionId => {
                        const section = document.querySelector(`section[data-section-id="${sectionId}"]`);
                        if (section) {
                            DOMElements.sortableSectionsContainer.appendChild(section);
                        }
                    });
                }
            },
            enterLayoutEditMode: () => {
                const editBtn = document.querySelector('[data-action="edit-layout"]');
                const controls = document.getElementById('edit-layout-controls');
                if(editBtn) editBtn.classList.add('hidden');
                if (controls) {
                    controls.classList.remove('hidden');
                    controls.classList.add('flex');
                }
                document.querySelectorAll('.drag-handle').forEach(handle => handle.classList.remove('hidden'));
                if (DOMElements.sortableSectionsContainer && typeof Sortable !== 'undefined') {
                    state.sortableInstance = new Sortable(DOMElements.sortableSectionsContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                    });
                }
            },
            exitLayoutEditMode: (save = false) => {
                if (save && state.sortableInstance) {
                    const newOrder = [...DOMElements.sortableSectionsContainer.children].map(el => el.dataset.sectionId);
                    utils.saveData(CONSTANTS.LAYOUT_ORDER_KEY, newOrder);
                } else {
                    actions.applyCustomLayout();
                }
                if (state.sortableInstance) {
                    state.sortableInstance.destroy();
                    state.sortableInstance = null;
                }
                const controls = document.getElementById('edit-layout-controls');
                if(controls) {
                    controls.classList.add('hidden');
                    controls.classList.remove('flex');
                }
                document.querySelector('[data-action="edit-layout"]')?.classList.remove('hidden');
                document.querySelectorAll('.drag-handle').forEach(handle => handle.classList.add('hidden'));
            },
            openAddTaskPopup: (defaults = {}) => {
                if (!DOMElements.addTaskPopup || !DOMElements.addTaskForm) return;
                const { date, text, subject } = defaults;
                
                DOMElements.addTaskForm.reset();
                document.getElementById('taskDateInput').value = date || '';
                document.getElementById('addTaskDate').textContent = date ? `日付: ${date}` : '日付を選択して予定を作成';
                document.getElementById('taskTextInput').value = text || '';
                document.getElementById('taskSubjectInput').value = subject || '';

                const subjectTagsContainer = document.getElementById('taskSubjectTags');
                if (subjectTagsContainer) {
                    subjectTagsContainer.innerHTML = '';
                    const subjects = [...new Set(utils.loadData(CONSTANTS.RECORDS_KEY).map(r => r.subject))];
                    subjects.forEach(s => {
                        const tag = document.createElement('button');
                        tag.type = 'button';
                        tag.className = 'subject-tag';
                        tag.textContent = s;
                        tag.dataset.action = 'select-subject-tag';
                        tag.style.borderColor = utils.getColorForSubject(s);
                        if (s === subject) {
                            tag.classList.add('selected');
                            tag.style.backgroundColor = utils.getColorForSubject(s);
                            tag.style.color = '#fff';
                        }
                        subjectTagsContainer.appendChild(tag);
                    });
                }
                DOMElements.addTaskPopup.classList.add('visible');
                document.getElementById('taskTextInput')?.focus();
            },
            completeReviewItem: (itemId) => {
                let reviewItems = utils.loadData(CONSTANTS.REVIEW_ITEMS_KEY);
                const itemIndex = reviewItems.findIndex(item => item.id === itemId);
                if (itemIndex === -1) return;
                
                const item = reviewItems[itemIndex];
                const newStage = (item.reviewStage || 0) + 1;

                if (newStage < CONSTANTS.REVIEW_INTERVALS.length) {
                    item.reviewStage = newStage;
                    const nextInterval = CONSTANTS.REVIEW_INTERVALS[newStage];
                    item.nextReviewDate = utils.dateToYYYYMMDD(utils.addDays(new Date(), nextInterval));
                } else { 
                    item.isCompleted = true; 
                }
                
                utils.saveData(CONSTANTS.REVIEW_ITEMS_KEY, reviewItems);
                utils.triggerConfetti();
                render.todaysReviewItems();
                render.weeklySchedule();
            },
            runAiFeature: async ({ forceRefresh = false } = {}) => {
                if (state.isAiRunning || !DOMElements.aiAdviceContainer || !DOMElements.refreshAiPlanBtn) return;
                const apiKey = localStorage.getItem(CONSTANTS.API_KEY_KEY);
                if (!apiKey) {
                    DOMElements.aiAdviceContainer.innerHTML = `<p class="text-[var(--ios-red)]">AI機能を利用するにはAPIキーを設定してください。</p>`;
                    return;
                }
                
                const currentWeekNumber = utils.getWeekNumber(new Date());
                const weeklyAiPlanKey = CONSTANTS.AI_PLAN_KEY_PREFIX + currentWeekNumber;
                const cachedPlan = utils.loadData(weeklyAiPlanKey, null);

                if (cachedPlan && !forceRefresh) {
                    actions.displayAiPlan(cachedPlan);
                    return;
                }
                
                try {
                    state.isAiRunning = true;
                    DOMElements.refreshAiPlanBtn.disabled = true;
                    DOMElements.refreshAiPlanBtn.querySelector('i')?.classList.add('fa-spin');
                    if(DOMElements.aiLoadingMessage) DOMElements.aiLoadingMessage.style.display = 'block';
                    DOMElements.aiAdviceContainer.innerHTML = '';

                    const records = utils.loadData(CONSTANTS.RECORDS_KEY);
                    const reviewItems = utils.loadData(CONSTANTS.REVIEW_ITEMS_KEY);
                    const surveyData = utils.loadData(CONSTANTS.AI_SURVEY_KEY_PREFIX + currentWeekNumber, null);

                    const basis = {
                        records: `${records.length}件の学習記録`,
                        reviewItems: `${reviewItems.filter(item => !item.isCompleted).length}件の復習項目`,
                        survey: surveyData ? '今週のアンケート回答あり' : '今週のアンケート回答なし',
                    };
                    const basisKey = CONSTANTS.AI_PLAN_BASIS_KEY_PREFIX + currentWeekNumber;
                    utils.saveData(basisKey, basis);
                    
                    const model = 'gemini-1.5-flash';
                    let prompt = `あなたは優秀な学習プランナーです。以下のユーザーの状況を考慮し、今週1週間の具体的な学習スケジュールと、学習を継続するための実践的なアドバイスを生成してください。

【ユーザーの状況】
- 学習記録: 直近の記録が${records.length}件あります。
- 復習項目: ${reviewItems.filter(item => !item.isCompleted).length}件の未完了の復習タスクがあります。`;

                    if (surveyData) {
                        prompt += `

【今週の学習アンケート回答】
- 特に集中したい教科: ${surveyData.focusSubjects.join(', ') || '特に指定なし'}
- 特に集中したい教材: ${surveyData.focusTextbooks.join(', ') || '特に指定なし'}
- 今週の学習ペース: ${surveyData.pace || '通常通り'}
- 今週の意気込み: ${surveyData.feeling || '未設定'}`;
                    }

                    prompt += `

【出力形式のルール】
必ず以下のキーを含むJSONオブジェクトのみを返してください。説明文やマークダウンのコードブロック指定(\`\`\`json)は絶対に含めないでください。
{
  "weekly_schedule": [
    {
      "dayOfWeek": "月曜日",
      "timeline": [
        {"task": "数学: 教科書P.30-35の復習"},
        {"task": "英語: 長文問題集を2題解く"}
      ]
    }
  ],
  "practical_advice": "ユーザーへの具体的なアドバイス（マークダウン形式の文字列）"
}`;
                    
                    const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    const response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (response.status === 429) {
                        throw new Error('Too Many Requests. しばらく待ってから再度お試しください。');
                    }
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    
                    const result = await response.json();
                    let aiGeneratedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!aiGeneratedText) throw new Error('No content from AI response.');

                    let jsonString;
                    const jsonMatch = aiGeneratedText.match(/```json\s*([\s\S]*?)\s*```/);
                    if (jsonMatch && jsonMatch[1]) {
                        jsonString = jsonMatch[1];
                    } else {
                        const plainJsonMatch = aiGeneratedText.match(/\{[\s\S]*\}/);
                        if (plainJsonMatch) {
                            jsonString = plainJsonMatch[0];
                        } else {
                            throw new Error('Valid JSON not found in AI response.');
                        }
                    }
                    
                    const parsedData = JSON.parse(jsonString);
                    
                    const aiData = {
                        schedule: parsedData.weekly_schedule,
                        advice: parsedData.practical_advice
                    };

                    utils.saveData(weeklyAiPlanKey, aiData);
                    actions.displayAiPlan(aiData);

                } catch (error) {
                    console.error("AI Feature Error:", error);
                    DOMElements.aiAdviceContainer.innerHTML = `<p class="text-[var(--ios-red)]">AIアドバイスの取得中にエラーが発生しました。AIの応答形式が正しくない可能性があります。少し待ってから、もう一度お試しください。</p>`;
                } finally {
                    state.isAiRunning = false;
                    DOMElements.refreshAiPlanBtn.disabled = false;
                    DOMElements.refreshAiPlanBtn.querySelector('i')?.classList.remove('fa-spin');
                    if(DOMElements.aiLoadingMessage) DOMElements.aiLoadingMessage.style.display = 'none';
                }
            },
            displayAiPlan: (aiData) => {
                if (!DOMElements.aiAdviceContainer) return;
                
                if (aiData && aiData.advice) {
                    if (typeof marked !== 'undefined') {
                        DOMElements.aiAdviceContainer.innerHTML = marked.parse(aiData.advice);
                    } else {
                        DOMElements.aiAdviceContainer.textContent = aiData.advice;
                    }
                } else {
                    DOMElements.aiAdviceContainer.innerHTML = `<p class="text-gray-400">AIからのアドバイスはありませんでした。内容を更新するには、右上の更新ボタンを押してください。</p>`;
                }

                if (aiData && aiData.schedule) {
                    state.aiSchedule = aiData.schedule;
                    render.weeklySchedule();
                }
            }
        };

        const handle = {
            click: (e) => {
                const target = e.target;
                const actionTarget = target.closest('[data-action]');
                
                if (!actionTarget) {
                    if (!target.closest('#notificationsPanel') && !target.closest('[data-action="show-notifications"]')) {
                        DOMElements.notificationsPanel.classList.add('hidden');
                    }
                    if (target.closest('.popup-overlay') && !target.closest('.popup-content')) {
                        utils.closeAllPopups();
                    }
                    return;
                }
                
                const action = actionTarget.dataset.action;

                switch (action) {
                    case 'show-notifications': DOMElements.notificationsPanel.classList.toggle('hidden'); break;
                    case 'close-notifications': DOMElements.notificationsPanel.classList.add('hidden'); break;
                    case 'open-survey-from-notification':
                        DOMElements.notificationsPanel.classList.add('hidden');
                        actions.openAiSettings();
                        break;
                    case 'prev-week': state.weekOffset--; render.weeklySchedule(); break;
                    case 'next-week': state.weekOffset++; render.weeklySchedule(); break;
                    case 'refresh-ai-plan': actions.runAiFeature({ forceRefresh: true }); break;
                    case 'open-ai-settings': actions.openAiSettings(); break;
                    case 'edit-layout': actions.enterLayoutEditMode(); break;
                    case 'save-layout': actions.exitLayoutEditMode(true); break;
                    case 'cancel-layout': actions.exitLayoutEditMode(false); break;
                    case 'add-task-open': actions.openAddTaskPopup({ date: actionTarget.dataset.date }); break;
                    case 'add-task-from-record': actions.openAddTaskPopup({ text: actionTarget.dataset.text, subject: actionTarget.dataset.subject }); break;
                    case 'complete-review': actions.completeReviewItem(actionTarget.dataset.reviewId); break;
                    case 'select-subject-tag':
                        const subjectTagsContainer = actionTarget.parentElement;
                        const currentSelectedTag = subjectTagsContainer.querySelector('.selected');
                        if (currentSelectedTag) {
                            currentSelectedTag.classList.remove('selected');
                            currentSelectedTag.style.backgroundColor = '';
                            currentSelectedTag.style.color = '';
                        }
                        actionTarget.classList.add('selected');
                        const subject = actionTarget.textContent;
                        actionTarget.style.backgroundColor = utils.getColorForSubject(subject);
                        actionTarget.style.color = '#fff';
                        document.getElementById('taskSubjectInput').value = subject;
                        break;
                    case 'switch-survey-tab':
                        const tab = actionTarget.dataset.tab;
                        const subjectTab = document.querySelector('[data-tab="subjects"]');
                        const textbookTab = document.querySelector('[data-tab="textbooks"]');
                        const subjectContainer = document.getElementById('survey-subjects-container');
                        const textbookContainer = document.getElementById('survey-textbooks-container');

                        if (tab === 'subjects') {
                            subjectTab.classList.add('active');
                            textbookTab.classList.remove('active');
                            subjectContainer.classList.remove('hidden');
                            textbookContainer.classList.add('hidden');
                        } else {
                            subjectTab.classList.remove('active');
                            textbookTab.classList.add('active');
                            subjectContainer.classList.add('hidden');
                            textbookContainer.classList.remove('hidden');
                        }
                        break;
                    case 'close-popup': utils.closeAllPopups(); break;
                }
            },
            change: (e) => {
                if (e.target.id === 'ai-schedule-toggle') {
                    utils.saveData(CONSTANTS.AI_SCHEDULE_VISIBLE_KEY, e.target.checked);
                    render.weeklySchedule();
                }
            },
            submit: (e) => {
                e.preventDefault();
                if (e.target.id === 'addTaskForm') {
                    const date = document.getElementById('taskDateInput').value;
                    const text = document.getElementById('taskTextInput').value.trim();
                    const subject = document.getElementById('taskSubjectInput').value;
                    
                    if (!date || !text) {
                        alert('日付と予定の内容を入力してください。');
                        return;
                    }
                    
                    const userTasks = utils.loadData(CONSTANTS.USER_TASKS_KEY);
                    userTasks.push({ id: crypto.randomUUID(), date, text, subject });
                    utils.saveData(CONSTANTS.USER_TASKS_KEY, userTasks);
                    
                    utils.closeAllPopups();
                    render.weeklySchedule();
                } else if (e.target.id === 'ai-survey-form') {
                    const weekNumber = utils.getWeekNumber(new Date());
                    
                    const selectedSubjects = Array.from(document.querySelectorAll('input[name="focus-subject"]:checked')).map(cb => cb.value);
                    const selectedTextbooks = Array.from(document.querySelectorAll('input[name="focus-textbook"]:checked')).map(cb => cb.value);

                    const surveyData = {
                        focusSubjects: selectedSubjects,
                        focusTextbooks: selectedTextbooks,
                        pace: document.getElementById('survey-pace').value,
                        feeling: document.getElementById('survey-feeling').value.trim(),
                    };
                    utils.saveData(CONSTANTS.AI_SURVEY_KEY_PREFIX + weekNumber, surveyData);
                    actions.clearSurveyNotification();
                    utils.triggerConfetti();
                    utils.closeAllPopups();
                    actions.runAiFeature({ forceRefresh: true });
                }
            }
        };
        
        function init() {
            DOMElements.body.addEventListener('click', handle.click);
            DOMElements.body.addEventListener('change', handle.change);
            DOMElements.body.addEventListener('submit', handle.submit);

            if (DOMElements.aiScheduleToggle) {
                DOMElements.aiScheduleToggle.checked = utils.loadData(CONSTANTS.AI_SCHEDULE_VISIBLE_KEY, true);
            }
            actions.applyCustomLayout();
            render.all();
            actions.runAiFeature({});
            actions.checkForSurveyNotification();

            DOMElements.body.classList.add('loaded');
        }

        init();
    });
})();
</script>
</body>
</html>
